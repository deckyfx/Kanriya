@inherits LayoutComponentBase
@using Kanriya.Server.Blazor.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject SimpleAuthStateProvider AuthStateProvider
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject BlazorLocalizationService L
@inject ICredentialManager CredentialManager

<CascadingAuthenticationState>
    <AuthorizeView Context="authContext">
        <Authorized>
            @{
                var tokenType = authContext.User.FindFirst("token_type")?.Value;
                var isBrand = !string.IsNullOrEmpty(tokenType) && tokenType == "BRAND";
                
                if (isBrand)
                {
                    var currentBrandId = authContext.User.FindFirst("brand_id")?.Value;
                    var currentBrandName = authContext.User.FindFirst("brand_name")?.Value ?? "Brand";
                    
                    <div class="page brand-layout">
                        <div class="sidebar brand-sidebar">
                            <BrandNavMenu />
                        </div>

                        <main>
                            <div class="top-row brand-top-row">
                                <div class="top-row-content">
                                    <div class="top-row-left">
                                        <MudText Typo="Typo.h6" Style="color: var(--mud-palette-primary); font-weight: 500;">
                                            @currentBrandName
                                        </MudText>
                                    </div>
                                    <div class="top-row-right">
                                        <CredentialSwitcher />
                                    </div>
                                </div>
                            </div>

                            <article class="content">
                                <CustomErrorBoundary>
                                    @Body
                                </CustomErrorBoundary>
                            </article>
                        </main>
                    </div>
                }
                else
                {
                    <div class="unauthorized-container">
                        <MudContainer MaxWidth="MaxWidth.Small">
                            <MudAlert Severity="Severity.Error" Icon="@Icons.Material.Filled.Block" Class="mt-8">
                                <MudText Typo="Typo.h6">Access Denied</MudText>
                                <MudText Typo="Typo.body2" Class="mt-2">
                                    This area requires brand context authentication. Please sign in with brand credentials.
                                </MudText>
                            </MudAlert>
                            <MudButton 
                                Variant="Variant.Filled" 
                                Color="Color.Primary" 
                                Class="mt-4"
                                StartIcon="@Icons.Material.Filled.SwapHoriz"
                                OnClick="NavigateToConsole">
                                Switch to Brand Context
                            </MudButton>
                        </MudContainer>
                    </div>
                }
            }
        </Authorized>
        <NotAuthorized>
            @if (!Navigation.Uri.Contains("/signin", StringComparison.OrdinalIgnoreCase))
            {
                <RedirectToLogin />
            }
            else
            {
                <div class="loading-container">
                    <div class="loading-content">
                        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                        <MudText Typo="Typo.h6" Class="mt-3">Loading...</MudText>
                    </div>
                </div>
            }
        </NotAuthorized>
    </AuthorizeView>
</CascadingAuthenticationState>

@code {
    protected override void OnInitialized()
    {
        L.Initialize();
    }
    
    private void NavigateToConsole()
    {
        Navigation.NavigateTo("/console");
    }
}

<style>
    .brand-layout {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    
    .brand-sidebar {
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
    }
    
    .brand-top-row {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    .page {
        display: flex;
        height: 100vh;
        position: relative;
        margin: 0;
    }
    
    .sidebar {
        width: 250px;
        flex-shrink: 0;
    }
    
    main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .top-row {
        height: 3.5rem;
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
    }
    
    .top-row-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    
    .top-row-left {
        display: flex;
        align-items: center;
    }
    
    .top-row-right {
        display: flex;
        align-items: center;
    }
    
    .content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }
    
    .unauthorized-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .loading-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .loading-content {
        text-align: center;
        padding: 3rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        color: #667eea;
    }
</style>